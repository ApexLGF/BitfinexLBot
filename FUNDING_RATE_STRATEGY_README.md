# Funding Rate 疊加策略說明

## 問題解決

原先的錯誤 `data slice too short for candle snapshot` 是因為 Bitfinex 的 funding 市場（如 fUSD）沒有傳統的 K 線數據。我們已經修復了這個問題。

## 解決方案

### 1. 替代數據源
- **原先**: 嘗試獲取 funding 市場的 K 線數據（不存在）
- **現在**: 使用 funding book 的利率數據來模擬市場狀態

### 2. 策略運作原理

1. **獲取市場數據**: 從 funding book 獲取當前市場的多層利率數據
2. **找到最高利率**: 分析這些利率數據，找到最高的作為基準利率
3. **疊加計算**: 基於基準利率進行分層疊加
4. **風險控制**: 確保所有利率都不低於配置的最小利率

### 3. 配置示例

```yaml
# Funding Rate 疊加策略
ENABLE_KLINE_STRATEGY: true          # 啟用策略
KLINE_PERIOD: "15m"                  # 參數名保持不變（便於兼容）
KLINE_STACKING_PERCENT: 0.001        # 疊加百分比 (0.1%)
KLINE_STACKING_LAYERS: 5             # 疊加層數
```

### 4. 實際運行示例

假設當前 funding book 中最高利率為 0.015%：

```
第1層：0.015% + (0 × 0.001) = 0.015%
第2層：0.015% + (1 × 0.001) = 0.016%
第3層：0.015% + (2 × 0.001) = 0.017%
第4層：0.015% + (3 × 0.001) = 0.018%
第5層：0.015% + (4 × 0.001) = 0.019%
```

### 5. 日誌輸出

策略運行時會產生以下日誌：

```
使用Funding Rate疊加策略計算貸出訂單...
在 20 條利率記錄中找到最高利率: 0.015000%
Funding Rate疊加策略基準利率: 0.015000% (來自funding book最高利率)
Funding Rate疊加策略: 5 層，每層金額: 1000.00，疊加比例: 0.1000%
Funding Rate疊加第1層: 利率 0.015000%, 金額 1000.00, 期間 2天
Funding Rate疊加第2層: 利率 0.016000%, 金額 1000.00, 期間 2天
...
```

### 6. 容錯機制

- 如果無法獲取 funding book 數據，會自動回退到最小利率策略
- 如果基準利率低於配置的最小利率，會使用最小利率
- 如果分層金額小於最小貸出額，會自動調整層數

### 7. 優勢

1. **適應性強**: 基於當前市場最高利率，確保競爭力
2. **風險分散**: 多層疊加，降低單一利率風險
3. **自動調整**: 隨市場變化自動調整基準利率
4. **容錯性好**: 多重保護機制，確保策略穩定運行

## 使用建議

1. **測試模式**: 建議先在 `TEST_MODE: true` 下運行，觀察策略表現
2. **參數調整**: 根據市場情況調整 `KLINE_STACKING_PERCENT` 和 `KLINE_STACKING_LAYERS`
3. **監控日誌**: 關注策略運行日誌，了解實際執行情況
4. **定期檢查**: 定期檢查策略效果，必要時調整參數

這個修復版本現在可以正常運行，不會再出現之前的錯誤。