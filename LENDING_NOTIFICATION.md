# 借貸訂單通知功能說明

## 📋 功能概述

借貸訂單通知功能會自動檢測新的借貸成交，並通過 Telegram 發送詳細通知。

## ⚙️ 配置參數

### `LENDING_CHECK_MINUTES`
- **說明**: 借貸訂單檢查間隔（分鐘）
- **預設值**: 10 分鐘
- **建議值**: 5-30 分鐘
- **範例**: 
  ```yaml
  LENDING_CHECK_MINUTES: 10  # 每10分鐘檢查一次新的借貸訂單
  ```

## 🔄 調度器架構

應用程式現在有三個獨立的調度器：

1. **主要任務調度器** (`MINUTES_RUN`)
   - 執行下單、取消等交易操作
   - 預設間隔由 `MINUTES_RUN` 控制

2. **借貸檢查調度器** (`LENDING_CHECK_MINUTES`) 
   - 檢查新的借貸成交
   - 發送 Telegram 通知
   - 獨立於主要任務運行

3. **利率檢查調度器** (固定每小時)
   - 檢查利率是否超過閾值
   - 發送利率提醒

## 📱 通知內容

當有新的借貸訂單時，會收到包含以下信息的通知：

```
💰 新的借貸訂單通知

📊 訂單 #1
💵 金額: 1000.00 USD
📈 日利率: 0.1200%
⏰ 期間: 30 天
💰 預期收益: 36.0000 USD
🕐 開始時間: 2025-06-29 14:30:15

📊 統計信息:
📦 總數量: 1 個訂單
💵 總金額: 1000.00 USD
💰 總預期收益: 36.0000 USD
```

## 🎛️ Telegram 指令

### `/lending`
查看當前所有活躍的借貸訂單，包含：
- 訂單詳細信息
- 收益計算
- 年化收益率統計

## 🔧 工作原理

1. **時間戳記錄**: 記錄上次檢查時間 (`LastLendingCheckTime`)
2. **新訂單檢測**: 比較借貸開始時間 (`MTSOpened`) 與上次檢查時間
3. **首次啟動處理**: 初始化時間戳，不發送現有訂單通知
4. **錯誤處理**: Telegram 未認證時記錄到日誌，不中斷主程序

## 📊 配置建議

### 測試環境
```yaml
MINUTES_RUN: 5              # 主要任務：5分鐘
LENDING_CHECK_MINUTES: 5    # 借貸檢查：5分鐘
TEST_MODE: true            # 啟用測試模式
```

### 正式環境
```yaml
MINUTES_RUN: 15             # 主要任務：15分鐘
LENDING_CHECK_MINUTES: 10   # 借貸檢查：10分鐘
TEST_MODE: false           # 正式模式
```

### 高頻監控
```yaml
MINUTES_RUN: 10             # 主要任務：10分鐘
LENDING_CHECK_MINUTES: 3    # 借貸檢查：3分鐘（更頻繁通知）
```

## 📝 日誌輸出

啟動時會顯示調度器配置：
```
⚙️ 主要任務間隔: 15 分鐘
💰 借貸檢查間隔: 10 分鐘
📊 利率檢查: 每小時
```

檢查時的日誌：
```
檢查新的借貸訂單...
首次檢查，發現 5 個現有的借貸訂單，初始化檢查時間戳
```

通知時的日誌：
```
發現 2 個新的借貸訂單
借貸訂單通知發送成功
```

## ⚠️ 注意事項

1. **首次啟動**: 不會對現有借貸訂單發送通知
2. **Telegram 認證**: 未認證時通知失敗會記錄到日誌
3. **API 限制**: 檢查間隔不建議小於 3 分鐘
4. **測試模式**: 不影響借貸檢查功能，仍會檢查真實訂單

## 🚀 升級說明

從舊版本升級時，新增的配置參數會自動設置預設值：
- 如未設置 `LENDING_CHECK_MINUTES`，預設為 10 分鐘
- 現有的 `MINUTES_RUN` 配置不受影響
- 借貸檢查功能會自動啟用